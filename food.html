<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì˜¤ëŠ˜ ì €ë… ë­ë¨¹ì§€? (ìƒ‰ë‹¤ë¥¸ ì¶”ì²œ)</title>
    <style>
        :root{
            --bg: #0b0f19;
            --card: rgba(255,255,255,.06);
            --card2: rgba(255,255,255,.08);
            --text: rgba(255,255,255,.92);
            --muted: rgba(255,255,255,.65);
            --line: rgba(255,255,255,.12);
            --accent: #8b5cf6;
            --accent2:#22c55e;
            --danger:#ef4444;
            --warn:#f59e0b;
            --shadow: 0 10px 35px rgba(0,0,0,.35);
            --radius: 18px;
        }
        *{ box-sizing:border-box; }
        body{
            margin:0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif;
            color: var(--text);
            background:
                    radial-gradient(900px 500px at 20% 10%, rgba(139,92,246,.28), transparent 55%),
                    radial-gradient(900px 500px at 80% 0%, rgba(34,197,94,.22), transparent 55%),
                    radial-gradient(900px 500px at 60% 100%, rgba(245,158,11,.18), transparent 55%),
                    var(--bg);
            min-height:100vh;
            padding: 28px 16px 60px;
        }
        .wrap{ max-width: 980px; margin:0 auto; }
        header{
            display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
            margin-bottom: 16px;
        }
        h1{ margin:0; font-size: 26px; letter-spacing:-.5px; }
        .sub{ margin:6px 0 0; color: var(--muted); font-size: 13px; }
        .pill{
            display:inline-flex; align-items:center; gap:8px;
            padding:8px 12px;
            border: 1px solid var(--line);
            border-radius: 999px;
            background: rgba(255,255,255,.04);
            box-shadow: var(--shadow);
            color: var(--muted);
            font-size: 12px;
            white-space:nowrap;
        }
        .grid{
            display:grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 14px;
        }
        @media (max-width: 880px){
            .grid{ grid-template-columns: 1fr; }
            header{ flex-direction:column; align-items:flex-start; }
        }
        .card{
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
        }
        .card h2{
            margin:0 0 12px;
            font-size: 15px;
            color: rgba(255,255,255,.86);
            display:flex;
            align-items:center;
            gap:10px;
        }
        .tabs{
            display:flex; flex-wrap:wrap; gap:8px;
            margin-bottom: 12px;
        }
        .tab{
            padding:10px 12px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(255,255,255,.03);
            color: var(--muted);
            font-size: 13px;
            cursor:pointer;
            user-select:none;
            transition: .15s ease;
        }
        .tab:hover{ background: rgba(255,255,255,.06); color: rgba(255,255,255,.86); }
        .tab.active{
            background: rgba(139,92,246,.22);
            border-color: rgba(139,92,246,.5);
            color: rgba(255,255,255,.92);
        }
        .section{ display:none; }
        .section.active{ display:block; }
        .row{ display:flex; gap:10px; flex-wrap:wrap; }
        .field{
            flex:1;
            min-width: 180px;
        }
        label{
            display:block;
            font-size: 12px;
            color: var(--muted);
            margin: 0 0 6px;
        }
        select, input, textarea{
            width:100%;
            padding: 12px 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            outline: none;
            background: rgba(255,255,255,.03);
            color: rgba(255,255,255,.9);
        }
        textarea{ min-height: 96px; resize: vertical; line-height: 1.35; }
        .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
        button{
            border: 0;
            padding: 12px 14px;
            border-radius: 14px;
            cursor:pointer;
            font-weight: 700;
            color: rgba(255,255,255,.92);
            background: rgba(139,92,246,.35);
            border: 1px solid rgba(139,92,246,.55);
            transition: .15s ease;
        }
        button:hover{ transform: translateY(-1px); background: rgba(139,92,246,.45); }
        button.secondary{
            background: rgba(255,255,255,.06);
            border: 1px solid var(--line);
            color: rgba(255,255,255,.86);
            font-weight: 650;
        }
        button.secondary:hover{ background: rgba(255,255,255,.09); }
        button.danger{
            background: rgba(239,68,68,.22);
            border-color: rgba(239,68,68,.45);
        }
        button.danger:hover{ background: rgba(239,68,68,.3); }
        .result{
            margin-top: 12px;
            padding: 14px;
            border-radius: var(--radius);
            border: 1px solid var(--line);
            background: var(--card2);
        }
        .result .big{
            font-size: 22px;
            font-weight: 900;
            letter-spacing: -.5px;
            margin: 0 0 8px;
        }
        .result .meta{
            color: var(--muted);
            font-size: 13px;
            line-height: 1.45;
            margin:0;
        }
        .kbd{
            display:inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(0,0,0,.12);
            color: rgba(255,255,255,.78);
            font-size: 12px;
            margin-right: 6px;
        }
        .list{
            display:flex; flex-wrap:wrap; gap:8px;
            margin-top: 10px;
        }
        .chip{
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(255,255,255,.04);
            color: rgba(255,255,255,.82);
            font-size: 12px;
            display:inline-flex;
            gap:6px;
            align-items:center;
        }
        .chip b{ color: rgba(255,255,255,.92); }
        .mini{
            color: var(--muted);
            font-size: 12px;
            margin-top: 8px;
            line-height: 1.4;
        }
        .mono{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background: rgba(0,0,0,.18);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            color: rgba(255,255,255,.88);
            line-height: 1.45;
            margin: 10px 0 0;
        }
        footer{
            margin-top: 14px;
            color: rgba(255,255,255,.5);
            font-size: 12px;
            text-align:center;
        }
        .right .card{ position: sticky; top: 16px; }
        @media (max-width: 880px){
            .right .card{ position: static; }
        }
        .twoCol{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 520px){
            .twoCol{ grid-template-columns: 1fr; }
        }
        select{
            background: rgba(255,255,255,.06);
            color: rgba(255,255,255,.92);
        }

        /* í¼ì³ì§„ ëª©ë¡(option)ì€ ë¸Œë¼ìš°ì €ê°€ ë”°ë¡œ ë Œë”ë§í•´ì„œ ë”°ë¡œ ì§€ì • í•„ìš” */
        select option{
            background: #111827; /* ì§„í•œ ë°°ê²½ */
            color: #ffffff;      /* í° ê¸€ì”¨ */
        }

        /* (ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ) optgroupë„ ê°™ì´ */
        select optgroup{
            background: #111827;
            color: #ffffff;
        }
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div>
            <h1>ì˜¤ëŠ˜ ì €ë… ë­ë¨¹ì§€? ğŸ½ï¸ <span style="opacity:.7;">(ìƒ‰ë‹¤ë¥¸ ì¶”ì²œ)</span></h1>
            <p class="sub">ìƒíƒœ ê¸°ë°˜ Â· ê°•ì œ ê²°ì • Â· ê°œë°œì ì¿¼ë¦¬ ëª¨ë“œ + ìµœê·¼/ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì €ì¥</p>
        </div>
        <div class="pill">
            <span>âš¡ ë¹ ë¥´ê²Œ ê²°ì •</span>
            <span style="opacity:.55;">|</span>
            <span id="today"></span>
        </div>
    </header>

    <div class="grid">
        <!-- LEFT -->
        <div class="left">
            <div class="card">
                <h2>ëª¨ë“œ ì„ íƒ</h2>
                <div class="tabs" id="tabs">
                    <div class="tab active" data-tab="mood">ìƒíƒœ ê¸°ë°˜ ì¶”ì²œ</div>
                    <div class="tab" data-tab="force">ê°•ì œ ê²°ì •</div>
                    <div class="tab" data-tab="dev">ê°œë°œì ì¿¼ë¦¬</div>
                </div>

                <!-- ìƒíƒœ ê¸°ë°˜ -->
                <div class="section active" id="sec-mood">
                    <div class="row">
                        <div class="field">
                            <label>ì˜¤ëŠ˜ ê¸°ë¶„</label>
                            <select id="mood">
                                <option value="tired">ğŸ˜µâ€ğŸ’« ì§€ì¹¨</option>
                                <option value="calm">ğŸ˜Œ í‰ì˜¨</option>
                                <option value="angry">ğŸ˜¡ ë¹¡ì¹¨</option>
                                <option value="happy">ğŸ˜„ ê¸°ë¶„ ì¢‹ìŒ</option>
                                <option value="sleepy">ğŸ˜´ ì¡¸ë¦¼</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>ë°°ê³ í””</label>
                            <select id="hunger">
                                <option value="low">ğŸ™‚ ì¡°ê¸ˆ</option>
                                <option value="mid">ğŸ˜‹ ë³´í†µ</option>
                                <option value="high">ğŸ¤¤ ë§¤ìš°</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>ì˜¤ëŠ˜ ë‚ ì”¨(ì²´ê°)</label>
                            <select id="weather">
                                <option value="normal">ğŸŒ¤ ë³´í†µ</option>
                                <option value="cold">ğŸ¥¶ ì¶”ì›€</option>
                                <option value="hot">ğŸ¥µ ë”ì›€</option>
                                <option value="rainy">ğŸŒ§ ë¹„ì˜´/ì¶•ì¶•</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>ìƒí™©</label>
                            <select id="situation">
                                <option value="solo">ğŸ™‹â€â™‚ï¸ í˜¼ë°¥</option>
                                <option value="coworker">ğŸ‘¥ ë™ë£Œ/ì¹œêµ¬</option>
                                <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±</option>
                                <option value="date">ğŸ’˜ ë°ì´íŠ¸</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" style="margin-top:10px;">
                        <div class="field">
                            <label>ì ì‹¬ ë­ ë¨¹ì—ˆì–´? (ê²¹ì¹˜ë©´ ì œì™¸)</label>
                            <input id="lunch" placeholder="ì˜ˆ: ì œìœ¡ / ê¹€ì¹˜ì°Œê°œ / ìƒëŸ¬ë“œ" />
                        </div>
                        <div class="field">
                            <label>ì œì™¸í•˜ê³  ì‹¶ì€ í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                            <input id="excludeKeywords" placeholder="ì˜ˆ: ë§¤ìš´, í•´ì‚°ë¬¼, ë°€ê°€ë£¨" />
                        </div>
                    </div>

                    <div class="btns">
                        <button id="btnRecommendMood">ì¶”ì²œí•´ì¤˜</button>
                        <button class="secondary" id="btnSaveLunch">ì ì‹¬ ì €ì¥</button>
                        <button class="secondary" id="btnAddBlacklistFromInput">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</button>
                    </div>

                    <div class="result" id="moodResult" style="display:none;">
                        <div class="big" id="moodTitle"></div>
                        <p class="meta" id="moodMeta"></p>
                        <div class="list" id="moodTags"></div>
                        <div class="mini">Tip: ê²°ê³¼ê°€ ë§ˆìŒì— ì•ˆ ë“¤ë©´ â€œì¶”ì²œí•´ì¤˜â€ë¥¼ ë‹¤ì‹œ ëˆŒëŸ¬.</div>
                    </div>
                </div>

                <!-- ê°•ì œ ê²°ì • -->
                <div class="section" id="sec-force">
                    <div class="twoCol">
                        <div class="field">
                            <label>ê²°ì • ë°©ì‹</label>
                            <select id="forceMode">
                                <option value="hard">ğŸŸ¥ ê³ ë¯¼ ê¸ˆì§€ (1ê°œ í™•ì •)</option>
                                <option value="two">ğŸŸ¨ í›„ë³´ 2ê°œë§Œ</option>
                                <option value="explain">ğŸŸ© ì„¤ëª… ë“£ê³  ê³ ë¥¼ë˜</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>ì˜ˆì‚°</label>
                            <select id="budget">
                                <option value="low">â‚© 5ì²œ~8ì²œ</option>
                                <option value="mid">â‚© 9ì²œ~1.2ë§Œ</option>
                                <option value="high">â‚© 1.3ë§Œ~</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>ì„¤ê±°ì§€/ì¡°ë¦¬ ê·€ì°®ìŒ</label>
                            <select id="effort">
                                <option value="zero">ğŸ§¼ 0 (ë°°ë‹¬/ë°–ì—ì„œ)</option>
                                <option value="low">ğŸ³ 10ë¶„ ë‚´</option>
                                <option value="mid">ğŸ§‘â€ğŸ³ 20~30ë¶„</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>ëƒ„ìƒˆ ë¬»ì–´ë„ ë¨?</label>
                            <select id="smell">
                                <option value="no">ğŸ™…â€â™‚ï¸ ì•ˆ ë¨</option>
                                <option value="ok">ğŸ‘Œ ìƒê´€ì—†ìŒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="btns">
                        <button id="btnForce">ê²°ì •í•´ì¤˜</button>
                        <button class="secondary" id="btnRerollForce">ë‹¤ì‹œ êµ´ë ¤</button>
                    </div>

                    <div class="result" id="forceResult" style="display:none;">
                        <div class="big" id="forceTitle"></div>
                        <p class="meta" id="forceMeta"></p>
                        <div class="list" id="forceTags"></div>
                        <div class="mini">â€œë‹¤ì‹œ êµ´ë ¤â€ëŠ” ê°™ì€ ì¡°ê±´ìœ¼ë¡œ ì¬ì¶”ì²œ.</div>
                    </div>
                </div>

                <!-- ê°œë°œì ì¿¼ë¦¬ -->
                <div class="section" id="sec-dev">
                    <div class="row">
                        <div class="field" style="flex:1.2;">
                            <label>ì•„ë¬´ë ‡ê²Œë‚˜ ì¨ë„ ë¨ (ì˜ˆ: í‡´ê·¼=ëŠ¦ìŒ, ë°°ê³ í””=MAX, ì„¤ê±°ì§€=ì‹«ìŒ)</label>
                            <textarea id="devInput" placeholder="ì˜ˆ)
í‡´ê·¼=ëŠ¦ìŒ
ë°°ê³ í””=MAX
ì„¤ê±°ì§€=ì‹«ìŒ
ë§¤ìš´ê±°=OK
í•´ì‚°ë¬¼=NO"></textarea>
                        </div>
                        <div class="field" style="flex:.8;">
                            <label>í”„ë¦¬ì…‹</label>
                            <select id="devPreset">
                                <option value="">ì„ íƒ ì•ˆ í•¨</option>
                                <option value="p1">ì•¼ê·¼+ì—ë„ˆì§€ ë°”ë‹¥</option>
                                <option value="p2">ë‹¤ì´ì–´íŠ¸+ë‹¨ë°±ì§ˆ</option>
                                <option value="p3">ë¹„ì˜¤ëŠ” ë‚ +êµ­ë¬¼</option>
                                <option value="p4">ë°ì´íŠ¸+ë¬´ë‚œ</option>
                            </select>

                            <div class="btns" style="margin-top:10px;">
                                <button id="btnDevRun">RUN</button>
                                <button class="secondary" id="btnDevExplain">ì¿¼ë¦¬ë¡œ ì„¤ëª…</button>
                            </div>

                            <div class="mini">
                                ê²°ê³¼ëŠ” â€œí˜„ì‹¤ DBâ€ì—ì„œ ë½‘ì•„ì˜´ ğŸ˜<br/>
                                (ì‚¬ì‹¤ì€ ë£° ê¸°ë°˜ ì¶”ì²œ)
                            </div>
                        </div>
                    </div>

                    <div class="result" id="devResult" style="display:none;">
                        <div class="big" id="devTitle"></div>
                        <p class="meta" id="devMeta"></p>
                        <div class="mono" id="devQuery"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="right">
            <div class="card">
                <h2>ë‚´ ì„¤ì •</h2>

                <div class="row">
                    <div class="field">
                        <label>ìµœê·¼ ë¨¹ì€ ë©”ë‰´ (ìë™ ì €ì¥)</label>
                        <div class="list" id="recentList"></div>
                        <div class="btns">
                            <button class="secondary" id="btnClearRecent">ìµœê·¼ ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </div>

                <div class="row" style="margin-top: 10px;">
                    <div class="field">
                        <label>ë¸”ë™ë¦¬ìŠ¤íŠ¸ (ìë™ ì œì™¸)</label>
                        <div class="list" id="blackList"></div>
                        <div class="btns">
                            <button class="secondary" id="btnClearBlacklist">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </div>

                <div class="row" style="margin-top: 10px;">
                    <div class="field">
                        <label>ì§ì ‘ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</label>
                        <input id="blackAdd" placeholder="ì˜ˆ: ê³±ì°½, íšŒ, ì¹˜í‚¨" />
                        <div class="btns">
                            <button class="secondary" id="btnAddBlacklist">ì¶”ê°€</button>
                        </div>
                        <div class="mini">ì‰¼í‘œë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥. í‚¤ì›Œë“œ í¬í•¨ ë©”ë‰´ëŠ” ì¶”ì²œì—ì„œ ì œì™¸ë¼.</div>
                    </div>
                </div>

                <hr style="border:0;border-top:1px solid var(--line); margin: 12px 0;" />

                <div class="mini">
                    <span class="kbd">Tip</span>
                    ê²°ê³¼ ë©”ë‰´ë¥¼ í´ë¦­í•˜ë©´ â€œìµœê·¼ ë©”ë‰´â€ì— ì €ì¥ë¼ì„œ, ë‹¤ìŒ ì¶”ì²œì—ì„œ ê²¹ì¹¨ì„ ì¤„ì—¬ì¤˜.
                </div>
            </div>
        </div>
    </div>

    <footer>Â© Dinner Decision Engine â€” localStorage only (ì„œë²„ ì—†ìŒ)</footer>
</div>

<script>
    // ===== ë‚ ì§œ í‘œì‹œ =====
    const todayEl = document.getElementById('today');
    const now = new Date();
    const pad2 = n => String(n).padStart(2,'0');
    todayEl.textContent = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;

    // ===== ë°ì´í„° (ì‹¤ë¬´ ê°ì„±: íƒœê·¸ ê¸°ë°˜) =====
    // tags: spicy, soup, light, heavy, rice, noodle, meat, seafood, fried, clean, fast, date, group, solo, budget_low, budget_mid, budget_high, smell, no_smell
    const MENUS = [
        { name:"êµ­ë°¥", tags:["soup","heavy","rice","fast","solo","budget_low"] },
        { name:"ê¹€ì¹˜ì°Œê°œ", tags:["soup","spicy","rice","fast","solo","budget_low","smell"] },
        { name:"ëœì¥ì°Œê°œ", tags:["soup","rice","clean","fast","solo","budget_low"] },
        { name:"ìˆœë‘ë¶€ì°Œê°œ", tags:["soup","spicy","rice","fast","solo","budget_low"] },
        { name:"ìŒ€êµ­ìˆ˜", tags:["soup","noodle","clean","fast","solo","budget_mid"] },
        { name:"ë¼ë©˜", tags:["soup","noodle","heavy","fast","solo","budget_mid","smell"] },
        { name:"íŒŒìŠ¤íƒ€", tags:["noodle","clean","date","group","budget_mid","no_smell"] },
        { name:"ìƒëŸ¬ë“œ+ë‹­ê°€ìŠ´ì‚´", tags:["light","clean","fast","solo","budget_mid","no_smell"] },
        { name:"ì´ˆë°¥", tags:["seafood","clean","date","group","budget_high","no_smell"] },
        { name:"íšŒë®ë°¥", tags:["seafood","rice","clean","solo","budget_mid"] },
        { name:"ì œìœ¡ë®ë°¥", tags:["meat","spicy","rice","heavy","fast","solo","budget_low","smell"] },
        { name:"ë¶ˆê³ ê¸°", tags:["meat","rice","group","budget_mid","smell"] },
        { name:"ì‚¼ê²¹ì‚´", tags:["meat","heavy","group","budget_high","smell"] },
        { name:"ì¹˜í‚¨", tags:["fried","heavy","group","budget_mid","smell"] },
        { name:"ëˆê¹ŒìŠ¤", tags:["fried","heavy","fast","solo","budget_mid"] },
        { name:"í–„ë²„ê±°", tags:["fast","heavy","solo","budget_mid","smell"] },
        { name:"í”¼ì", tags:["heavy","group","budget_high","smell"] },
        { name:"ì¹¼êµ­ìˆ˜", tags:["soup","noodle","heavy","fast","solo","budget_low"] },
        { name:"ìš°ë™", tags:["soup","noodle","clean","fast","solo","budget_low"] },
        { name:"ë¹„ë¹”ë°¥", tags:["rice","clean","solo","budget_mid","no_smell"] },
        { name:"ì½©ë‚˜ë¬¼êµ­ë°¥", tags:["soup","rice","clean","fast","solo","budget_low"] },
        { name:"ë§ˆë¼íƒ•", tags:["soup","spicy","heavy","group","budget_mid","smell"] },
        { name:"ë–¡ë³¶ì´+íŠ€ê¹€", tags:["spicy","fried","heavy","group","budget_low","smell"] },
        { name:"ìƒ¤ë¸Œìƒ¤ë¸Œ", tags:["soup","clean","group","date","budget_high","no_smell"] },
        { name:"ì¹´ë ˆ", tags:["rice","fast","solo","budget_low","smell"] },
        { name:"ì˜¤ë¯€ë¼ì´ìŠ¤", tags:["rice","clean","date","solo","budget_mid","no_smell"] },
    ];

    // ===== ì €ì¥ì†Œ =====
    const LS_RECENT = "dinner_recent_v1";
    const LS_BLACK = "dinner_black_v1";
    const LS_LUNCH  = "dinner_lunch_v1";

    const load = (k, def) => {
        try {
            const v = JSON.parse(localStorage.getItem(k));
            return (v === null || v === undefined) ? def : v;
        } catch(e){ return def; }
    }
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    let recent = load(LS_RECENT, []);
    let blacklist = load(LS_BLACK, []);
    let lastForced = null;

    const normalize = s => (s||"").toString().trim().toLowerCase();

    // ===== UI helpers =====
    const recentListEl = document.getElementById("recentList");
    const blackListEl = document.getElementById("blackList");

    function renderChips(el, items, kind){
        el.innerHTML = "";
        if(!items.length){
            const empty = document.createElement("div");
            empty.className="chip";
            empty.style.opacity=.55;
            empty.textContent = kind === "recent" ? "ì•„ì§ ì—†ìŒ" : "ë¹„ì–´ìˆìŒ";
            el.appendChild(empty);
            return;
        }
        items.forEach((it, idx) => {
            const chip = document.createElement("div");
            chip.className="chip";
            if(kind === "recent"){
                chip.innerHTML = `<b>ğŸ½</b> ${it}`;
                chip.title="í´ë¦­í•˜ë©´ ìµœê·¼ëª©ë¡ì—ì„œ ì œê±°";
                chip.style.cursor="pointer";
                chip.onclick = () => {
                    recent = recent.filter((x,i)=> i!==idx);
                    save(LS_RECENT, recent);
                    renderAll();
                };
            } else {
                chip.innerHTML = `<b>â›”</b> ${it} <span style="opacity:.6;">Ã—</span>`;
                chip.title="í´ë¦­í•˜ë©´ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°";
                chip.style.cursor="pointer";
                chip.onclick = () => {
                    blacklist = blacklist.filter((x,i)=> i!==idx);
                    save(LS_BLACK, blacklist);
                    renderAll();
                };
            }
            el.appendChild(chip);
        });
    }

    function addRecent(menuName){
        const n = menuName.trim();
        if(!n) return;
        recent = [n, ...recent.filter(x => x !== n)].slice(0, 14);
        save(LS_RECENT, recent);
        renderAll();
    }

    function addBlacklistFromText(text){
        const parts = (text||"").split(",").map(s => s.trim()).filter(Boolean);
        if(!parts.length) return;
        parts.forEach(p => {
            const key = p.toLowerCase();
            if(!blacklist.map(x=>x.toLowerCase()).includes(key)){
                blacklist.unshift(p);
            }
        });
        // ê¸¸ì´ ì œí•œ
        blacklist = blacklist.slice(0, 40);
        save(LS_BLACK, blacklist);
        renderAll();
    }

    function renderAll(){
        renderChips(recentListEl, recent, "recent");
        renderChips(blackListEl, blacklist, "black");
        // ì ì‹¬ í‘œì‹œ
        const lunchSaved = load(LS_LUNCH, "");
        const lunchInput = document.getElementById("lunch");
        if(lunchSaved && !lunchInput.value) lunchInput.value = lunchSaved;
    }

    // ===== íƒ­ ì „í™˜ =====
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(t => {
        t.addEventListener("click", () => {
            tabs.forEach(x=>x.classList.remove("active"));
            t.classList.add("active");
            const id = t.dataset.tab;
            document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
            document.getElementById("sec-"+id).classList.add("active");
        });
    });

    // ===== ì¶”ì²œ ì—”ì§„ =====
    function isBlacklisted(menuName, extraKeywords=[]){
        const all = [...blacklist, ...extraKeywords].map(normalize).filter(Boolean);
        const target = normalize(menuName);
        return all.some(k => k && target.includes(k));
    }

    function tagScore(menu, wants=[], avoids=[]){
        // wants/avoids: tag strings
        let score = 10; // base
        wants.forEach(t => { if(menu.tags.includes(t)) score += 6; });
        avoids.forEach(t => { if(menu.tags.includes(t)) score -= 8; });
        // ê°€ë” ë‹¤ì–‘ì„±
        score += Math.floor(Math.random() * 4);
        return score;
    }

    function pickOne(candidates){
        if(!candidates.length) return null;
        candidates.sort((a,b)=> b.score - a.score);
        // ìƒìœ„ 6ê°œì—ì„œ ëœë¤ ì„ íƒ (ë„ˆë¬´ ë»”í•˜ì§€ ì•Šê²Œ)
        const top = candidates.slice(0, Math.min(6, candidates.length));
        return top[Math.floor(Math.random()*top.length)];
    }

    function lunchToExcludeKeywords(lunchText){
        const t = normalize(lunchText);
        if(!t) return [];
        // ë„ˆë¬´ ì •êµí•˜ê²Œ ì•ˆ í•˜ê³ , ëŒ€í‘œ í‚¤ì›Œë“œë§Œ
        const map = [
            { k:["ì¹˜í‚¨","ë‹­"], out:["ì¹˜í‚¨","ë‹­"] },
            { k:["ì œìœ¡","ì‚¼ê²¹","ê³ ê¸°","ë¶ˆê³ ê¸°"], out:["ì œìœ¡","ì‚¼ê²¹","ë¶ˆê³ ê¸°","ê³ ê¸°"] },
            { k:["êµ­ë°¥","ì°Œê°œ","êµ­","íƒ•"], out:["êµ­ë°¥","ì°Œê°œ","êµ­","íƒ•"] },
            { k:["ë©´","ë¼ë©˜","ìš°ë™","íŒŒìŠ¤íƒ€","ìŒ€êµ­ìˆ˜","ì¹¼êµ­ìˆ˜"], out:["ë©´","ë¼ë©˜","ìš°ë™","íŒŒìŠ¤íƒ€","ìŒ€êµ­ìˆ˜","ì¹¼êµ­ìˆ˜"] },
            { k:["ì´ˆë°¥","íšŒ","í•´ì‚°ë¬¼"], out:["ì´ˆë°¥","íšŒ","í•´ì‚°ë¬¼"] },
        ];
        for(const m of map){
            if(m.k.some(x => t.includes(x))) return m.out;
        }
        // ê¸°ë³¸: ì ì‹¬ ë‹¨ì–´ë¥¼ ê·¸ëŒ€ë¡œ ì¼ë¶€ ì œì™¸ í‚¤ì›Œë“œë¡œ ì‚¬ìš©
        const rough = lunchText.split(/[\s/]+/).map(s=>s.trim()).filter(s=>s.length>=2);
        return rough.slice(0,3);
    }

    function recommendByMood(){
        const mood = document.getElementById("mood").value;
        const hunger = document.getElementById("hunger").value;
        const weather = document.getElementById("weather").value;
        const situation = document.getElementById("situation").value;
        const lunch = document.getElementById("lunch").value;
        const excludeKeywords = document.getElementById("excludeKeywords").value;

        const extraExclude = [
            ...lunchToExcludeKeywords(lunch),
            ...(excludeKeywords||"").split(",").map(s=>s.trim()).filter(Boolean)
        ];

        // wants/avoids tags
        const wants = [];
        const avoids = [];

        // mood rules
        if(mood === "tired"){ wants.push("soup","fast"); avoids.push("heavy"); }
        if(mood === "sleepy"){ wants.push("fast"); avoids.push("heavy"); }
        if(mood === "angry"){ wants.push("spicy","heavy"); }
        if(mood === "calm"){ wants.push("clean"); avoids.push("spicy"); }
        if(mood === "happy"){ wants.push("group"); wants.push("fried"); }

        // hunger rules
        if(hunger === "low"){ wants.push("light"); avoids.push("heavy"); }
        if(hunger === "mid"){ /* noop */ }
        if(hunger === "high"){ wants.push("heavy"); }

        // weather rules
        if(weather === "cold" || weather === "rainy"){ wants.push("soup"); }
        if(weather === "hot"){ wants.push("clean","light"); avoids.push("heavy"); }

        // situation rules
        if(situation === "solo"){ wants.push("solo","fast"); }
        if(situation === "coworker"){ wants.push("group"); }
        if(situation === "family"){ wants.push("group"); }
        if(situation === "date"){ wants.push("date","clean"); avoids.push("smell"); }

        // candidates
        const candidates = [];
        MENUS.forEach(m => {
            if(isBlacklisted(m.name, extraExclude)) return;
            // recentì— ìˆëŠ” ë©”ë‰´ëŠ” ì ìˆ˜ ê°ì†Œ (ì™„ì „ ì œì™¸ëŠ” ì•„ë‹˜)
            const recentPenalty = recent.includes(m.name) ? 6 : 0;
            const score = tagScore(m, wants, avoids) - recentPenalty;
            candidates.push({ menu:m, score });
        });

        const picked = pickOne(candidates);
        return { picked, wants, avoids, extraExclude };
    }

    function recommendForce(){
        const mode = document.getElementById("forceMode").value;
        const budget = document.getElementById("budget").value;
        const effort = document.getElementById("effort").value;
        const smell = document.getElementById("smell").value;

        const wants = [];
        const avoids = [];

        // budget tags
        if(budget === "low") wants.push("budget_low");
        if(budget === "mid") wants.push("budget_mid");
        if(budget === "high") wants.push("budget_high");

        // effort
        if(effort === "zero") wants.push("fast");
        if(effort === "low") wants.push("fast");
        if(effort === "mid") { /* ok */ }

        // smell
        if(smell === "no") avoids.push("smell");

        const candidates = [];
        MENUS.forEach(m => {
            if(isBlacklisted(m.name)) return;
            const recentPenalty = recent.includes(m.name) ? 5 : 0;
            const score = tagScore(m, wants, avoids) - recentPenalty;
            candidates.push({ menu:m, score });
        });

        candidates.sort((a,b)=> b.score - a.score);
        const top = candidates.slice(0, Math.min(10, candidates.length));

        if(mode === "hard"){
            return { mode, picks: [ top[Math.floor(Math.random()*Math.min(6, top.length))] ], wants, avoids };
        }
        if(mode === "two"){
            const a = top[Math.floor(Math.random()*Math.min(6, top.length))];
            let b = top[Math.floor(Math.random()*Math.min(6, top.length))];
            if(b?.menu?.name === a?.menu?.name) b = top[Math.min(5, top.length-1)];
            return { mode, picks: [a,b].filter(Boolean), wants, avoids };
        }
        // explain
        const picks = top.slice(0,3);
        return { mode, picks, wants, avoids };
    }

    function parseDevInput(raw){
        const lines = (raw||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const map = {};
        lines.forEach(line => {
            const m = line.split("=");
            if(m.length>=2){
                const k = m[0].trim().toLowerCase();
                const v = m.slice(1).join("=").trim().toLowerCase();
                map[k]=v;
            } else {
                // ë‹¨ë… í‚¤ì›Œë“œ
                map[line.toLowerCase()] = "true";
            }
        });
        return map;
    }

    function devRecommend(raw){
        const kv = parseDevInput(raw);
        const wants = [];
        const avoids = [];

        // ë£°: ëŒ€ì¶© í•´ì„
        const hunger = kv["ë°°ê³ í””"] || kv["hunger"] || "";
        const late = kv["í‡´ê·¼"] || kv["ì•¼ê·¼"] || "";
        const dish = kv["ì„¤ê±°ì§€"] || kv["ìš”ë¦¬"] || "";
        const spicy = kv["ë§¤ìš´ê±°"] || kv["spicy"] || "";
        const seafood = kv["í•´ì‚°ë¬¼"] || kv["seafood"] || "";
        const smell = kv["ëƒ„ìƒˆ"] || "";

        if(hunger.includes("max") || hunger.includes("ë§¤ìš°") || hunger.includes("ë§ì´")) wants.push("heavy");
        if(late.includes("ëŠ¦") || late.includes("ì•¼ê·¼") || kv["ì•¼ê·¼"]){ wants.push("fast"); wants.push("soup"); }
        if(dish.includes("ì‹«") || dish.includes("no") || dish.includes("0")) wants.push("fast");
        if(spicy.includes("ok") || spicy.includes("yes") || spicy.includes("true")) wants.push("spicy");
        if(spicy.includes("no")) avoids.push("spicy");
        if(seafood.includes("no")) avoids.push("seafood");
        if(seafood.includes("ok") || seafood.includes("yes")) wants.push("seafood");
        if(smell.includes("no") || smell.includes("x")) avoids.push("smell");

        // ê¸°ë³¸ê°’: í˜¼ë°¥ì´ë©´ solo ì‚´ì§
        if(kv["í˜¼ë°¥"] || kv["solo"]) wants.push("solo");

        const candidates = [];
        MENUS.forEach(m => {
            if(isBlacklisted(m.name)) return;
            const recentPenalty = recent.includes(m.name) ? 6 : 0;
            const score = tagScore(m, wants, avoids) - recentPenalty;
            candidates.push({ menu:m, score });
        });

        const picked = pickOne(candidates);

        // query text
        const where = [];
        wants.forEach(t => where.push(`tags CONTAINS '${t}'`));
        avoids.forEach(t => where.push(`tags NOT CONTAINS '${t}'`));
        where.push(`blacklist NOT MATCH`);
        where.push(`recent PENALTY`);
        const sql =
            `SELECT dinner_menu
FROM í˜„ì‹¤_DB
WHERE
  ${where.join("\n  AND ")}
ORDER BY score DESC
LIMIT 1;`;

        return { picked, wants, avoids, sql, kv };
    }

    // ===== ê²°ê³¼ ë Œë” =====
    function showMoodResult(res){
        const box = document.getElementById("moodResult");
        const title = document.getElementById("moodTitle");
        const meta = document.getElementById("moodMeta");
        const tags = document.getElementById("moodTags");

        if(!res.picked){
            box.style.display="block";
            title.textContent = "ì¶”ì²œ ì‹¤íŒ¨ ğŸ˜µ";
            meta.textContent = "ë¸”ë™ë¦¬ìŠ¤íŠ¸/ì œì™¸ í‚¤ì›Œë“œê°€ ë„ˆë¬´ ë§ì•„ì„œ í›„ë³´ê°€ ì—†ì–´. ì œì™¸ ì¡°ê±´ì„ ì¤„ì—¬ë´.";
            tags.innerHTML = "";
            return;
        }

        const menuName = res.picked.menu.name;
        title.textContent = `ğŸ‘‰ ì˜¤ëŠ˜ ì €ë…: ${menuName}`;
        meta.innerHTML =
            `ì ìš© ì¡°ê±´: <span class="kbd">WANTS</span> ${res.wants.join(", ") || "ì—†ìŒ"} Â· ` +
            `<span class="kbd">AVOIDS</span> ${res.avoids.join(", ") || "ì—†ìŒ"}<br/>` +
            `ìë™ ì œì™¸: ${res.extraExclude.length ? res.extraExclude.join(", ") : "ì—†ìŒ"} Â· ìµœê·¼ íŒ¨ë„í‹°: ${recent.includes(menuName) ? "ì ìš©ë¨" : "ì—†ìŒ"}`;

        tags.innerHTML = "";
        res.picked.menu.tags.slice(0,8).forEach(t => {
            const chip = document.createElement("div");
            chip.className="chip";
            chip.textContent = "#"+t;
            tags.appendChild(chip);
        });

        box.style.display="block";
        // í´ë¦­í•˜ë©´ ìµœê·¼ ì €ì¥
        title.style.cursor="pointer";
        title.title="í´ë¦­í•˜ë©´ ìµœê·¼ ë©”ë‰´ë¡œ ì €ì¥";
        title.onclick = () => addRecent(menuName);
    }

    function showForceResult(res){
        const box = document.getElementById("forceResult");
        const title = document.getElementById("forceTitle");
        const meta = document.getElementById("forceMeta");
        const tags = document.getElementById("forceTags");

        if(!res.picks?.length){
            box.style.display="block";
            title.textContent = "í›„ë³´ ì—†ìŒ ğŸ˜µ";
            meta.textContent = "ë¸”ë™ë¦¬ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê°•í•¨. ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ ì¤„ì—¬ë´.";
            tags.innerHTML = "";
            return;
        }

        tags.innerHTML = "";
        const names = res.picks.map(p => p.menu.name);

        if(res.mode === "hard"){
            title.textContent = `â— ê³ ë¯¼ ê¸ˆì§€: ${names[0]}`;
            meta.textContent = `ì¡°ê±´: wants(${res.wants.join(", ")||"ì—†ìŒ"}) / avoids(${res.avoids.join(", ")||"ì—†ìŒ"})`;
            const chip = document.createElement("div");
            chip.className="chip";
            chip.innerHTML = "<b>í™•ì •</b> í´ë¦­í•˜ë©´ ìµœê·¼ ì €ì¥";
            tags.appendChild(chip);

            title.style.cursor="pointer";
            title.onclick = () => addRecent(names[0]);
        }

        if(res.mode === "two"){
            title.textContent = `ğŸŸ¨ í›„ë³´ 2ê°œ: ${names[0]} vs ${names[1]}`;
            meta.textContent = `ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ê³¨ë¼. (í´ë¦­í•˜ë©´ ìµœê·¼ ì €ì¥)`;
            names.forEach(n => {
                const chip = document.createElement("div");
                chip.className="chip";
                chip.style.cursor="pointer";
                chip.textContent = n;
                chip.onclick = () => addRecent(n);
                tags.appendChild(chip);
            });
        }

        if(res.mode === "explain"){
            title.textContent = `ğŸŸ© ìƒìœ„ í›„ë³´ TOP 3`;
            meta.textContent = `ì„¤ëª…: ì¡°ê±´ì— ê°€ì¥ ì˜ ë§ëŠ” ìˆœì„œ. (í´ë¦­í•˜ë©´ ìµœê·¼ ì €ì¥)`;
            res.picks.forEach(p => {
                const chip = document.createElement("div");
                chip.className="chip";
                chip.style.cursor="pointer";
                chip.innerHTML = `<b>${p.menu.name}</b> <span style="opacity:.65;">score ${p.score}</span>`;
                chip.onclick = () => addRecent(p.menu.name);
                tags.appendChild(chip);
            });
        }

        box.style.display="block";
    }

    function showDevResult(res, explain=false){
        const box = document.getElementById("devResult");
        const title = document.getElementById("devTitle");
        const meta = document.getElementById("devMeta");
        const query = document.getElementById("devQuery");

        if(!res.picked){
            box.style.display="block";
            title.textContent = "ê²°ê³¼ ì—†ìŒ ğŸ˜µ";
            meta.textContent = "ë¸”ë™ë¦¬ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê°•í•¨. ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ ì¤„ì—¬ë´.";
            query.textContent = res.sql || "";
            return;
        }

        const name = res.picked.menu.name;
        title.textContent = `âœ… RESULT: ${name}`;
        title.style.cursor="pointer";
        title.title="í´ë¦­í•˜ë©´ ìµœê·¼ ë©”ë‰´ë¡œ ì €ì¥";
        title.onclick = () => addRecent(name);

        meta.textContent = explain
            ? `í•´ì„: wants(${res.wants.join(", ")||"ì—†ìŒ"}) / avoids(${res.avoids.join(", ")||"ì—†ìŒ"}) â€” ë£° ê¸°ë°˜ ì¶”ì²œ`
            : `ì…ë ¥ íŒŒì‹± ì™„ë£Œ. (í´ë¦­í•˜ë©´ ìµœê·¼ ì €ì¥)`;

        query.textContent = res.sql;
        box.style.display="block";
    }

    // ===== ë²„íŠ¼ ì´ë²¤íŠ¸ =====
    document.getElementById("btnRecommendMood").onclick = () => {
        const res = recommendByMood();
        showMoodResult(res);
    };

    document.getElementById("btnSaveLunch").onclick = () => {
        const lunch = document.getElementById("lunch").value || "";
        save(LS_LUNCH, lunch);
        alert("ì ì‹¬ ì €ì¥ ì™„ë£Œ!");
    };

    document.getElementById("btnAddBlacklistFromInput").onclick = () => {
        const ex = document.getElementById("excludeKeywords").value || "";
        if(!ex.trim()){
            alert("ì œì™¸ í‚¤ì›Œë“œë¥¼ ë¨¼ì € ì…ë ¥í•´ì¤˜. (ì‰¼í‘œë¡œ êµ¬ë¶„)");
            return;
        }
        addBlacklistFromText(ex);
        alert("ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í–ˆì–´!");
    };

    document.getElementById("btnAddBlacklist").onclick = () => {
        const v = document.getElementById("blackAdd").value || "";
        if(!v.trim()){
            alert("ì¶”ê°€í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì¤˜.");
            return;
        }
        addBlacklistFromText(v);
        document.getElementById("blackAdd").value = "";
    };

    document.getElementById("btnClearRecent").onclick = () => {
        if(!confirm("ìµœê·¼ ë©”ë‰´ë¥¼ ì´ˆê¸°í™”í• ê¹Œ?")) return;
        recent = [];
        save(LS_RECENT, recent);
        renderAll();
    };

    document.getElementById("btnClearBlacklist").onclick = () => {
        if(!confirm("ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í• ê¹Œ?")) return;
        blacklist = [];
        save(LS_BLACK, blacklist);
        renderAll();
    };

    document.getElementById("btnForce").onclick = () => {
        lastForced = recommendForce();
        showForceResult(lastForced);
    };

    document.getElementById("btnRerollForce").onclick = () => {
        // ê°™ì€ ì¡°ê±´ìœ¼ë¡œ ë‹¤ì‹œ ì¶”ì²œí•˜ë ¤ë©´ ê·¸ëƒ¥ ë‹¤ì‹œ ì‹¤í–‰ (ì¡°ê±´ ê°’ì€ ìœ ì§€)
        lastForced = recommendForce();
        showForceResult(lastForced);
    };

    document.getElementById("devPreset").onchange = (e) => {
        const v = e.target.value;
        const input = document.getElementById("devInput");
        const presets = {
            p1: "í‡´ê·¼=ëŠ¦ìŒ\në°°ê³ í””=MAX\nì„¤ê±°ì§€=ì‹«ìŒ\në§¤ìš´ê±°=OK",
            p2: "ë‹¤ì´ì–´íŠ¸=true\në°°ê³ í””=mid\në§¤ìš´ê±°=NO\ní˜¼ë°¥=true",
            p3: "ë‚ ì”¨=rainy\ní‡´ê·¼=ë³´í†µ\në°°ê³ í””=high\nêµ­ë¬¼=true",
            p4: "ë°ì´íŠ¸=true\nëƒ„ìƒˆ=NO\në°°ê³ í””=mid\në§¤ìš´ê±°=NO"
        };
        if(presets[v]) input.value = presets[v];
    };

    document.getElementById("btnDevRun").onclick = () => {
        const raw = document.getElementById("devInput").value || "";
        const res = devRecommend(raw);
        showDevResult(res, false);
    };

    document.getElementById("btnDevExplain").onclick = () => {
        const raw = document.getElementById("devInput").value || "";
        const res = devRecommend(raw);
        showDevResult(res, true);
    };

    // ì´ˆê¸° ë Œë”
    renderAll();
</script>
</body>
</html>
